% ----------------------------------------------------------------------------
\chapter{Chat Protocol Definition}
%%    4. Protocol definition paper (containing chat features,
%%            data types, transport methods, security measures)
% ----------------------------------------------------------------------------
\section{Features}
This section describes which features are supported by the chat protocol.
Figure \ref{features-technologies} gives a quick overview of how the
features relate to the used technologies.
\begin{figure}
    \centering
    \caption{Features and Technologies}
    \label{features-technologies}
    \includegraphics[scale=0.8]{features-technologies.eps}
\end{figure}
% ----------------------------------------------------------------------------
\subsection{Anonymity}
One of the main objectives of this thesis is to provide a chat system that
hides who is talking to whom (\textit{Sender-Receiver Anonymity}). 
In practise there are limits on the degree of anonymity that can be reached.


If an attacker controls all hosts that are 
part of the chat network, it is impossible to guarantee anonymity.

Thus the implementation should support be resistent against a high percentage
of attacker nodes in the network.

Level of anonymity in theory - nodes

Winning chances in Lotto are expressed like this:
$$P_r = \frac{{\binom{6}{r}}{\binom{N-6}{6-r}}}{{\binom{N}{6}}}, r \in \{0, \ldots, 6\}$$

To remove anonymity, all peers in a route, which are not the 
sender and the receiver have to be compromised.
Depending on the number of hosts in a network (number of possible
numbers in lotto) and on the number of hosts in a specific route
(number of correct numbers in lotto), the de-anonymisation
probalities (lotto: winning probabilities) are shown in table
\ref{deanontable}

%\begin{longtable}{|c|c|c|c|c|c|c|c|c|}
\begin{longtable}{|c|c|c|c|c|c|}
\caption{De-Anonymisation Probablities (for one packet)}
\label{deanontable}\\
\hline
\textbf{Peers in network /} & \textbf{$10$} & \textbf{$10^2$} & \textbf{$10^3$} & \textbf{$10^4$} & \textbf{$10^5$} \\
\textbf{Proxy peers} & & & & & \\
\hline
\textbf{1} & 1:10 & 1:100 & 1:1000 & 1:10000 & 1:100000\\
\hline
\textbf{2} & 1:45 & 1:4950 & 1:499500 & 1:4.9995e+07 & 1:4.99995e+09\\
\hline
\textbf{3} & 1:120 & 1:161700 & 1:1.66167e+08 & 1:1.66617e+11 & 1:1.66662e+14\\
\hline
\textbf{4} & 1:210 & 1:3.92122e+06 & 1:4.14171e+10 & 1:4.16417e+14 & 1:4.16642e+18\\
\hline
\textbf{5} & 1:252 & 1:7.52875e+07 & 1:8.25029e+12 & 1:8.325e+17 & 1:8.3325e+22\\
\hline
\textbf{6} & 1:210 & 1:1.19205e+09 & 1:1.36817e+15 & 1:1.38681e+21 & 1:1.38868e+27\\
\hline
\textbf{7} & 1:120 & 1:1.60076e+10 & 1:1.94281e+17 & 1:1.97996e+24 & 1:1.98371e+31\\
\hline
\textbf{8} & 1:45 & 1:1.86088e+11 & 1:2.41151e+19 & 1:2.47322e+27 & 1:2.47946e+35\\
\hline
\textbf{9} & 1:10 & 1:1.90223e+12 & 1:2.65802e+21 & 1:2.74583e+30 & 1:2.75474e+39\\
\hline
\textbf{10} & 1:1 & 1:1.73103e+13 & 1:2.6341e+23 & 1:2.74336e+33 & 1:2.75449e+43\\
\hline
\end{longtable}
To support a high chance of not hitting the attackers peers and thus
avoiding de-anonymisation, the number
of peers in the network as well as the number of proxy peers should be
increased as much as possible. The number of peers in the network are
depending on how many peers are actually using the network. This can be
increased to a certain degree by adding artificial peers.
The number of proxy peers cannot be increades infinitely, because every
additional proxy peers adds an amount of time to the latency until the
message arrives.

hoi, hoi ... latency counts afterwards. but includes reaction time.

% ----------------------------------------------------------------------------
\subsection{Authenticity}
Digital signatures provide methods to ensure that a given message
was composed by a given public key and that the content has not been
modified.
% ----------------------------------------------------------------------------
\subsection{Confidentiality}
The process of encryption protects data and thus ensures the
confidentiality of a message.
% ----------------------------------------------------------------------------
\subsection{Availability}
% ----------------------------------------------------------------------------
\subsection{Non security related features}
This chat protocol version supports only direct chat as opposed to
multi user / group chat.

% ----------------------------------------------------------------------------
\section{Transport Protocols}
This chat protocol does not rely on a specific underlying transport protocol,
but is \textit{transport protocol independent}. Transport protocols are used
to submit 


On the "`wire"'. Different transports. Constant transport.
Define name (postcard?!) here. Includes transport specific
header / meta information.

% ----------------------------------------------------------------------------
\subsection{Tunneling}
aginst firewall rules / blocking of traffic
through http
steganographic

% ----------------------------------------------------------------------------
\subsection{Multiplexing / Variable Addresses}
Different transports for one peer.

% ----------------------------------------------------------------------------
\subsection{List of Supported Transports}
To ensure interoperability, clients which support a specific
protocol version must support all listed transport protocols.
\begin{longtable}{|c|c|c|}
\caption{Transport protocols}\\
\hline
\textbf{Protocol} & \textbf{Description} & \textbf{Supported versions}\\
\hline
tcp & Transmission Control Protocol & 0.1 - 0.1\\
\hline
\end{longtable}

% ----------------------------------------------------------------------------
\section{Encryption and Digital Signature}
Message encryption and digital signatures are
used as defined in the OpenPGP RFC.\cite{rfc2440}
% ----------------------------------------------------------------------------
\section{Onion Routing}
Onion routing is used to ensure sender-receiver anonymity. In contrast
to the Tor-network, there are no exit nodes and the receiver can be anyone
in the onion chain (see fig. \ref{onionrouting}).

\subsection{Variable Peers}
Different routes for every packet

\subsection{Source based routing}
Either here or in Intra Machine Intra Client
\subsection{Peer selection}
Which peers, how many. Constant? May give upper bounds of latency.

8 * 0.5seconds = 4 seconds delay.


%% \begin{figure}
%%     \centering
%%     \caption{Onion Routing}
%%     \label{onionrouting}
%%     \includegraphics[scale=0.8]{onionrouting.eps}
%% \end{figure}
% ----------------------------------------------------------------------------
\subsection{Packet sizes}
The average packet size depending on the number of peers it was
(re-)encrypted for can be found in table \ref{pkgsizes}.
It was generated by running the reference implementation
(\verb=ceof onion -m "test" peer0  | wc -c=)
and increasing the number of proxy peers to be inserted.
The resulting size includes only the final onion,
but does not include transport protocol headers.
\begin{longtable}{|c|c|}
\caption{Packet sizes (experimental)}
\label{pkgsizes}\\
\hline
\textbf{Proxy peers} & \textbf{Packet size (in KiBiBytes)}\\
\hline
\textbf{1} & 1.2\\
\hline
\textbf{2} & 1.9\\
\hline
\textbf{3} & 2.6\\
\hline
\textbf{4} & 3.3\\
\hline
\textbf{5} & 4.0\\
\hline
\textbf{6} & 4.8\\
\hline
\textbf{7} & 5.6\\
\hline
\textbf{8} & 6.3\\
\hline
\textbf{9} & 7.1\\
\hline
\textbf{10} & 8.0\\
\hline
\end{longtable}


% ----------------------------------------------------------------------------
\section{Noise}

purpose of ... 

There are many situations in which an EOFi sends out data to the network,
although you did not write a message: In fact, as EOFi \textbf{always}
sends packets in a fixed interval, it needs to have data to encrypt and send.

Noise can be any type of random data. As the current random number generators
are quite expensive, it is recommend to use a huge dictionary, old 
messages, logfiles, public emails, etc. for noise input.
% Nico: 1.0

% ----------------------------------------------------------------------------
\subsection{Fixed interval for sending}
To prevent de-anonymisation by doing statistical analysis on the traffic,
postcards are being at a fixed rate.
In case there is not message to be send, messages with no receiving
party (\textit{noise}) must be used instead.

To avoid problems with different sending intervals
(queuing, buffer exceeding) a network wide fixed sending interval
should be chosen. From the calculations made above, an interval
of \textbf{0.25s} seems to provide a good tradeoff between
latency, anonymity and bandwidth usage.

The number of proxy peers can be choosen by every peer individually
and can be used to focus on smaller bandwidth usage or higher degree
of anonymity. A value of 5 in a network of 100 peers
would make de-anonymising less probable than winning Lotto in Germany
(6 of 49). A value of 8 delays the message at maximum 2 seconds until
it is received.

% ----------------------------------------------------------------------------
\subsubsection{Average Latency}
The average latency for a peer is calculated as follows:
$$\frac{\sum\limits_{i=0}^{(Proxy peers +1)}}{Proxy peers + 1}$$
Depending on how long the waiting delay in seconds is, this results
in different average waiting times for message to arrive, as expressed in
the following formula:
$$Delaytime * \frac{\sum\limits_{i=0}^{(Proxy peers +1)}}{Proxy peers + 1}$$

\begin{longtable}{|c|c|c|c|c|c|c|}
\caption{Average latency based on number of proxy peers}
\label{avglatencypeers}\\
\hline
\multirow{2}{*}{\textbf{Proxy peers}} & \multicolumn{6}{|l|}{\textbf{Average latency (multiplied by delay times)}} \\
& \textbf{(\# timeslots)} & \textbf{0.125s} & \textbf{0.25s} & \textbf{0.5s} & \textbf{1s} & \textbf{2s}\\
\hline
\textbf{1} & 0.5 & 0.0625s & 0.125s & 0.25s & 0.5s & 1s\\
\hline
\textbf{2} & 1 & 0.125s & 0.25s & 0.5s & 1s & 2s\\
\hline
\textbf{3} & 1.5 & 0.1875s & 0.375s & 0.75s & 1.5s & 3s\\
\hline
\textbf{4} & 2 & 0.25s & 0.5s & 1s & 2s & 4s\\
\hline
\textbf{5} & 2.5 & 0.3125s & 0.625s & 1.25s & 2.5s & 5s\\
\hline
\textbf{6} & 3 & 0.375s & 0.75s & 1.5s & 3s & 6s\\
\hline
\textbf{7} & 3.5 & 0.4375s & 0.875s & 1.75s & 3.5s & 7s\\
\hline
\textbf{8} & 4 & 0.5s & 1s & 2s & 4s & 8s\\
\hline
\textbf{9} & 4.5 & 0.5625s & 1.125s & 2.25s & 4.5s & 9s\\
\hline
\textbf{10} & 5 & 0.625s & 1.25s & 2.5s & 5s & 10s\\
\hline
\end{longtable}
A study about 
\textit{System Response Time and User Satisfaction}\cite{responsetime}
indicates that response times up to 6 seconds are tolerable, these numbers
cannot be related directly to the tolerated delay, because the receiving
peer does not know when the sending peer sent a message.
% ----------------------------------------------------------------------------
\subsubsection{Maximum Latency}
Furthermore besides the average latency, the maximum latency needs
to be taken into account, which is shown in table \ref{maxlatencypeers}.
\begin{longtable}{|c|c|c|c|c|c|c|}
\caption{Maximum latency based on number of proxy peers}
\label{maxlatencypeers}\\
\hline
\multirow{2}{*}{\textbf{Proxy peers}} & \multicolumn{6}{|l|}{\textbf{Maximum latency (multiplied by delay times)}} \\
& \textbf{(\# timeslots)} & \textbf{0.125s} & \textbf{0.25s} & \textbf{0.5s} & \textbf{1s} & \textbf{2s}\\
\hline
\textbf{1} & 1 & 0.125s & 0.25s & 0.5s & 1s & 2s\\
\hline
\textbf{2} & 2 & 0.25s & 0.5s & 1s & 2s & 4s\\
\hline
\textbf{3} & 3 & 0.375s & 0.75s & 1.5s & 3s & 6s\\
\hline
\textbf{4} & 4 & 0.5s & 1s & 2s & 4s & 8s\\
\hline
\textbf{5} & 5 & 0.625s & 1.25s & 2.5s & 5s & 10s\\
\hline
\textbf{6} & 6 & 0.75s & 1.5s & 3s & 6s & 12s\\
\hline
\textbf{7} & 7 & 0.875s & 1.75s & 3.5s & 7s & 14s\\
\hline
\textbf{8} & 8 & 1s & 2s & 4s & 8s & 16s\\
\hline
\textbf{9} & 9 & 1.125s & 2.25s & 4.5s & 9s & 18s\\
\hline
\textbf{10} & 10 & 1.25s & 2.5s & 5s & 10s & 20s\\
\hline
\end{longtable}
% ----------------------------------------------------------------------------
\subsection{Bandwidth usage}
Based on the calculated packet sizes (\ref{packetsizes}), 
the following \textbf{outgoing bandwidth}
is needed, as can be seen in table \ref{bandwidth}.
The highest needed bandwidth
in case of 10 proxy peers sending at an interval of 0.125s results in 64 KiB/s
or 512 KBit/s. Todays DSL connections usually exceed this limit by magnitudes
\begin{longtable}{|c|c|c|c|c|c|}
\caption{Outgoing bandwidth usage}
\label{bandwidth}\\
\hline
\multirow{2}{*}{\textbf{Proxy peers}} & \multicolumn{5}{|l|}{\textbf{Intervals / Bandwidth usage in KiB/s}} \\
& \textbf{0.125s} & \textbf{0.25s} & \textbf{0.5s} & \textbf{1s} & \textbf{2s}\\
\hline
\textbf{1} & 9.6 & 4.8 & 2.4 & 1.2 & 0.6\\
\hline
\textbf{2} & 15.2 & 7.6 & 3.8 & 1.9 & 0.95\\
\hline
\textbf{3} & 20.8 & 10.4 & 5.2 & 2.6 & 1.3\\
\hline
\textbf{4} & 26.4 & 13.2 & 6.6 & 3.3 & 1.65\\
\hline
\textbf{5} & 32 & 16 & 8 & 4 & 2\\
\hline
\textbf{6} & 38.4 & 19.2 & 9.6 & 4.8 & 2.4\\
\hline
\textbf{7} & 44.8 & 22.4 & 11.2 & 5.6 & 2.8\\
\hline
\textbf{8} & 50.4 & 25.2 & 12.6 & 6.3 & 3.15\\
\hline
\textbf{9} & 56.8 & 28.4 & 14.2 & 7.1 & 3.55\\
\hline
\textbf{10} & 64 & 32 & 16 & 8 & 4\\
\hline
\end{longtable}
Even on mobile networks, HSUPA Category 1 delivers 0.73 Mbit/s upstream bandwidth.
Older ISDN and Modem connections would not suffice, though
today there are a lot of alternative connections available.\cite{wiki:bitrates}
If using only 9 proxy servers with 0.125s delay or
10 proxy servers with a delay of 0.25s, EDGE could be supported.

The total required network bandwidth is the product of peers in the
network multiplied by the outgoing bandwidth per peer:
$$Required Network Bandwidth = Network Peers * Peer Bandwidth$$
Thus a network with 100 peers, all of them which use 10 proxy peers
and send at a rate of 0.125s, the total required network bandwidth would be
$$RNB = 100 * 64 KiB/s = 6400 KiB/s = 6.25MiB/s = 50 MBit/s$$
If also the receiving side is inside the same network, the required network
bandwith has to be multiplied by two and thus results in 
\textit{100 MBit/s}. This is exactly half of what a fast ethernet switch
can deliver, because fast ethernet provides full duplex 100Mbit/s streams
and thus a single fast ethernet fabric would support 200 simultaneous users.
As the network bandwidth cannot be controlled or influenced by the user
directly, these calculations may simply indicate the network bandwidth
usage for network providers. The user can focus on the bandwith specifications
found in table \ref{bandwidth}.

% ----------------------------------------------------------------------------
\subsection{Inter Machine Inter Program Protocol}
After decoding the received packet. Forward, etc.
Based on part os EOF simple data types.
\subsubsection{Message types}
List of messages here
\subsubsection{Message 1}
description here

% ----------------------------------------------------------------------------
\subsection{Version}
As soon as this standard is usable and the first version of \emph{rEOFi}
is released, it will version number \textbf{01} of the standard.
Further changes will be documented in this section. All version numbers
are two ASCII digits (see below).
% Nico: FIXME for 1.0

% Nico: 1.0
% #############################################################################
