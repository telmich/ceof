% ----------------------------------------------------------------------------
\chapter{Implementation of the Prototype}
% 5. Technical documentation and prototype for the new chat system
% ----------------------------------------------------------------------------
\section{Usage}
How to use.
% ----------------------------------------------------------------------------
\section{Development Process}
spiral
% ----------------------------------------------------------------------------
\section{Environment}
% ----------------------------------------------------------------------------
\subsection{Preperation}
\begin{verbatim}
% virtualenv python-env
% . ./python-env/bin/activate
% pip install python-gnupg
% (cd python-env/bin && ln -s python python3)
\end{verbatim}
python gnupg, virtualenv
Cross-OS. Posix and/or ansi-c. ui changable.
Sockets, Environment, Paths, etc.
Support for different OS would have made development more
hard, so support for POSIX alike operating systems was targeted.

\section{Python and GPG}
Various implementations \cite{python-gpg}
PyMe: 3 Nachrichten in 2010
\url{http://sourceforge.net/mailarchive/forum.php?forum_name=pyme-help&style=threaded}

python-gnupg commits in september 2011 \cite{python-gnupg}

Selected python-gnupg

\subsection{Configuration}
The configuration of EOFi is stored in the cconfig\cite{cconfig} format.
% Nico: FIXME for 1.0: cite

% ----------------------------------------------------------------------------
\section{Related Project: Chat UI}
Own program, indepentend of core, side project
% ----------------------------------------------------------------------------
\section{Code Examples}
% ----------------------------------------------------------------------------
\subsection{Modular Design}
UI seperated.
Portable Core.
id, base 64, 
queuing
forks
manual poll

noise

\subsubsection{Sub Programs}
Consists of the following sub-programs:
encryption, dictionary, key/peer exchange daemon (if possible in this work),
modular design
Different programs handle different objectives

\subsection{Encryption}
Splitting of encryption into a seperate program can make use of
multiple computing ressources.
% ----------------------------------------------------------------------------
\subsection{Noise Engine}
To generate noise, all files from a specific directory are read.
Should be UTF-8 encoded files.

\begin{verbatim}
% cd ~/.ceof 
% mkdir noise
% cd noise 
# Linux Kernel is a good source for noise
% find ~/p/linux/linus -name '*.c' -type f -exec ln -fs {} \;
# Add some rfcs to the noise soup
% find ~/oeffentlich/rechner/netz/rfc/mirror/rfcs-text-only/ -name '*.txt' -type f -exec ln -fs {} \;
% ls | wc -l
23287
\end{verbatim}

Generate input for times when there is no user input.
Random or db or or or.
Networt traffic

\subsection{Transport protocols}
% ----------------------------------------------------------------------------
\section{Command Line Options}

% ----------------------------------------------------------------------------
\section{Tests}
% ----------------------------------------------------------------------------
\subsection{Performance}
%\subsection{Packet size}
Re-testing of crypt (using test/recrypt): 5.2 - 5.3 KiB per packet.

\subsection{Bandwidth usage}
After protocol overhead...

% ----------------------------------------------------------------------------


% ----------------------------------------------------------------------------
\section{Supported Features}
Based on the requirements defined in \ref{requirements}, 
p. \pageref{requirements}, the following features have been implemented. 
% MIRROR of that chapter here!

% ----------------------------------------------------------------------------
\subsection{Anonymity}
Multi-Hop onion routingg

Sender verification
Before the encrypt the packet, it is signed via public-key
cryptography\cite{pgp-1}. Thus only the receiver can verify the message sender.

\subsubsection{obfuscation}
- Hide message sending 

We don't think it's possible to hide that you are part of the chat network,
because some heuristics will be developed to detect the chat packets.
So we use a different idea:
Every participant of an EOF network will constantly send chat packets
with a pre-defined frequency (for instance every 250 ms). 
If you don't chat, \emph{noise} is sent.\footnote{Noise is just random
data, see below for a more detailled description of noise.}
The noise is also used to defend against timing analysis.
In case you are sending out a message, the message packet will be added to the
queue and sent within the next free time slot.

From outside it can easily be seen, that you are part of the network,
but not, if you sent a message.

\subsubsection{Hide message receiver}
The message packets are always sent indirectly via onion routing\cite{onion-1}.
The idea is taken from the Tor project\cite{tor-1}, though EOF uses an enhanced
version: EOF does not know about entry or exit nodes. If you are the intended
receiver you may or may not continue to forward the message, which is defined
by the sender of the message. That said, EOF must use source 
routing\cite{source-routing-1}.

To support onion routing, the sender of a packet needs to encrypt the packet
multiple times, once for each host that receives the packet. This may look
as follows:
\begin{enumerate}
\item Create message (from noise or user input)
\item Create source path
\item Create packet for last peer ("`pkg-last"')
\item Create packet for last-1 peer including \emph{pkg-last}
\item Continue until first peer is reached
\item Sent packet to first peer 
\end{enumerate}
Thus every peer only knows the previous and the next peer.
% Nico: 1.0


\subsection{Availability}
To prevent
successful elimination of the service, a decentralised architecture should


\subsubsection{Reliable against single user attacks}
Traditional chat networks depend on one or more central organised servers.
An attacker can stop all communication, if she runs a successful denial
of service ("`DoS"') attack against the central systems.
To protect against this, EOF uses a dynamic peer-to-peer network, which works
as long as the minimun number of peers and the destination peer is available.
It has no dependency on a central server.

\subsubsection{Hide packets in network stream}
As said before, we don't think it's possible to hide the participation in the
chat network. To be able to send packets, although an attacker \emph{knows}
about the participation, EOF embeds all chat packets into other (well known)
protocols (which is knows as steganography\cite{stegano-1}).
EOF does not implement nor specify \emph{transport protocols} itself.
The EOF community is urged to implement them in a creative way: Usage
of well-known protocols like TCP\cite{tcp-1}, HTTP\cite{http-1},
SMTP\cite{smtp-1} or even transmission of packets on avian
carriers\cite{avian-1} are encouraged. The tunneling of EOF packets through
those protocols (also know as obfuscation) makes it harder to detect
and \emph{block} EOF traffic. 
If an attacker wants you to stop sending messages, she has to completly
remove you from the network, because any open protocol may be (ab)used to
encapsulate EOF packets into it.
% Nico: 1.0 




\subsection{Confidentiality}

\subsection{Integrity}
Before the encrypt the packet, it is signed via public-key
cryptography\cite{pgp-1}. Thus only the receiver can verify the message sender.


% ----------------------------------------------------------------------------
\section{Usage}


% #############################################################################
\section{Transport protocols ("`eofi2tp"')}
\label{eofi2tp}
% -----------------------------------------------------------------------------
\subsection{Definition/Specification}
URL, URI, Scheme clearification, use tcp:// and http:// syntax.


% -----------------------------------------------------------------------------
\subsection{Introduction}
Every transport protocol consists of a listening (\verb=listen=)
and sending (\verb=send=) part. When the EOFi starts, it starts all
transport protocols, which should the remain started and listen
for commands issued by the EOFi.
URLs are used as defined in RFC3986\cite{uri-1}.
For schemes only lower-case names are allowed
(to prevent problems with case-insensitive filesystems).
% -----------------------------------------------------------------------------
\subsection{Paths}
\label{tppaths}
All paths are relative to the directory p\_tp\_d, as described
in \ref{ptpd} on p. \pageref{ptpd}.
\begin{longtable}{|c|c|}
\caption{Required transport protocols}\\
\hline
\textbf{Scheme} & \textbf{Name}\\
\hline
\verb=available/= & Available transport procols\\
\hline
\verb=available/<scheme>/listen= & Listener (executable) for the scheme\\
\hline
\verb=available/<scheme>/send= & Sender (executable) for the scheme\\
\hline
\verb=listen/= & Enabled listeners\\
\hline
\verb=listen/<freeform>/url= & URL \\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsubsection{Enabling a scheme}
\label{tpscheme}
To enable support for the scheme \verb=http=
create both, the \verb=listen= and the \verb=send= executable below
\verb=available/http=.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{Enabling a listener}
\label{tplisten}
To enable a listener for the scheme \emph{http} at the URL
\emph{http://www.example.com/eof}, create
the directory \verb=listen/http-example= and the file
\verb=listen/http-example/url= with the content
\verb=http://www.example.com/eof=.
If the transport protocol implementation needs or allows additional
configuration files, they should be placed in the same directory.
The EOF implementation will parse the URL and check whether the
scheme is supported.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Required implementations}
\label{tprequired}
This version of the EOF standard requires support for the following
transport protocols in the implementation:
\begin{longtable}{|c|c|c|c|}
\caption{Required transport protocols}\\
\hline
\textbf{Scheme} & \textbf{Name} & \textbf{Format} & \textbf{Description}\\
\hline
tcp & IP/TCP & \verb=tcp:host:port= & Plain tcp\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{Upcoming implementations}
\label{tpupcoming}
The following transport protocol implementations have been proposed,
but are not yet implemented and thus not yet part of the standard:

\begin{longtable}{|c|c|c|c|}
\caption{Upcoming transport protocols}\\
\hline
\textbf{Scheme} & \textbf{Name} & \textbf{Format} & \textbf{Description}\\
\hline
dns & DNS       & \verb=dns:host:port:type= & Package via DNS\\
\hline
http & HTTP       & \verb=http:host:port/path= & Plain http\\
\hline
https & HTTPS     & \verb=https:host:port/path= & http with ssl\\
\hline
mailto & E-Mail   & \verb=mailo:address= & Send package as e-mail\\
\hline
mediawiki & Mediawiki   & \verb=mediawiki:host:port:page= & Transfer via Mediawiki\\
\hline
smb  & SMB     & \verb=smb:[user[:password]@]host:path= & Server message block\\
\hline
smtp & SMTP     & \verb=smtp:[user[:password]@]host:port= & http with ssl\\
\hline
tcps & IP/TCP/SSL & \verb=tcps:host:port= & tcp with ssl around\\
\hline
udp & IP/UPD      & \verb=udp:host:port= & Plain UDP\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{Developing and integrating implementations}
If you want to create a new transport protocol, create the two
executables as described in \ref{tppaths} and put them in their
scheme directory.
If the implementation works fine and you would like to add it to EOF,
create the directory \verb=tp/<scheme>/<implementation_name>= within
the EOFi source directory and update the following
sections of this document:
\begin{itemize}
\item \ref{tprequired}
\item \ref{tprequired} / new subsubsection for the new scheme
\item \ref{tpupcoming}
\end{itemize}

The name of the subsubsection is the name of the scheme
plus the registered implementation ("`like tcp-c"').
Every such subsubsection must at least contain:
\begin{itemize}
\item Author contact information
\item URL of website
\item Programming language
\end{itemize}
Keep the subsubsections sorted by alphabet.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1000: Send packet}
\index{Command!1000}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Destination & EOFsdt: addr & complete URL (with "`\emph{scheme:}"') & tcp:127.0.0.3:42\\
\hline
Size & EOFsdt: size & Size of message, excluding this header & 424242\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item 2000
\item 2001
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1000: Example}
Added linebreak after some \textbackslash{}0 for readability, which are \textbf{not} in
the real packet!
\begin{verbatim}
1000abfudh127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\010\0\0\0\0HEREISDATA
\end{verbatim}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1001: Enable listening}
\index{Command!1001}%
When the listening transport protocol starts up, EOFi sends this command and
waits for the acknowledge package, before it marks the transport protocol as enabled.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Destination & EOFsdt: addr & URL without "`\emph{scheme:}"' & 127.0.0.3:42\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item 2003
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1001: Example}
\begin{verbatim}
1001afdb12127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{1002: Stop listening}
\index{Command!1002}%
This command requests a listening transport protocol to shutdown.
It should free all ressources and exit. After a grace time (maybe seconds,
not yet defined), EOFi will kill the badly behaving transport protocol.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{1003: Prepare sending}
\index{Command!1003}%
This command requests a transport protocol sender to prepare for sending out
data. The transport protocol should initialise itself and acknowledge
when it is ready for sending.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1003 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{1004: Stop sending}
\index{Command!1004}%
This command requests a transport protocol sender to shutdown.
It should free all ressources and exit. After a grace time (maybe seconds,
not yet defined), EOFi will kill the badly behaving transport protocol.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1004 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2000: Packet successfully sent}
This code is returned by the transport protocol subsystem to EOFi on success.
After this return code, the transport protocol exits.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2001: Packet not sent}
\index{Command!2001}
This code is returned by the transport protocol subsystem to the
EOF implementation on failure.
After this return code, the transport protocol exits.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2002: Received packet}
\index{Command!2002}
The listening transport protocol received a packet and notifies EOFi.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2002 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Size & EOFsdt:size & Excluding the 2002 and this field & 42\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2003: Listening}
\index{Command!2003}
This code is returned by the listening transport protocol, as soon as the
listening process is ready to receive data. After that, EOFi can announce
the listening URL to other EOFi.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2003 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2004: Not listening}
\index{Command!2004}
If something happended that makes the listening transport protocol
unable to startup, it issues this command and exits afterwards.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2004 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Reason & EOFsdt: msgtxt & Why the connection was refused & Too many UIs connected.\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2005: Ready for sending}
\index{Command!2005}
This code is returned by the transport protocol sender, as soon as the
process is ready to send data.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2005 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{2006: Sender preperation error}
\index{Command!2006}
If something happended that makes the transport protocol sender
unable to startup, it issues this command and exits afterwards.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2006 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Reason & EOFsdt: msgtxt & Why the connection was refused & Too many UIs connected.\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% #############################################################################
% #############################################################################


